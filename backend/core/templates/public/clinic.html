{# backend/core/templates/public/clinic.html #}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Clinic Token Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- Clean hospital-style font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #f6fbff;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --line: #e5eef7;

      --brand: #0ea5a4;
      --brand2:#22c55e;

      --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      --radius: 18px;
    }

    html, body{
      height: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    body{
      margin:0;
      font-family: "Inter", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 420px at 15% 0%, #e9fbff 0%, transparent 60%),
        radial-gradient(900px 420px at 85% 0%, #e9fff4 0%, transparent 60%),
        linear-gradient(180deg, #ffffff, var(--bg));
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 22px 18px 40px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .logo{
      width:48px;height:48px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(14,165,164,1), rgba(34,197,94,1));
      box-shadow: 0 10px 22px rgba(14,165,164,.20);
      display:grid;
      place-items:center;
      color:white;
      font-weight:800;
      letter-spacing:-.03em;
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.28), transparent 55%);
      transform: rotate(18deg);
    }

    .title h1{
      margin:0;
      font-size: 20px;
      letter-spacing:-0.02em;
      font-weight:800;
    }
    .title p{
      margin:4px 0 0;
      color: var(--muted);
      font-size: 13px;
      font-weight:600;
    }

    .chips{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.8);
      border: 1px solid var(--line);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.05);
      font-size: 13px;
      font-weight:700;
      color: var(--text);
    }

    .liveDot{
      width:10px;height:10px;border-radius:999px;
      background: #22c55e;
      box-shadow: 0 0 0 6px rgba(34,197,94,.15);
    }

    /* Quote banner */
    .quote{
      margin-top: 18px;
      background: linear-gradient(180deg, #ffffff, #fbfeff);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px;
      display:flex;
      gap: 12px;
      align-items:flex-start;
    }

    .quoteIcon{
      width:44px;height:44px;border-radius: 14px;
      background: rgba(34,197,94,.10);
      border: 1px solid rgba(34,197,94,.18);
      display:grid; place-items:center;
      flex: 0 0 auto;
    }

    .quoteText{
      line-height: 1.25;
    }
    .quoteText .big{
      font-weight: 800;
      letter-spacing:-0.02em;
      font-size: 16px;
      margin: 0;
    }
    .quoteText .small{
      margin: 6px 0 0;
      color: var(--muted);
      font-weight: 700;
      font-size: 13px;
    }

    /* Main grid */
    .grid{
      margin-top: 18px;
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap: 16px;
      align-items:start;
    }

    @media (max-width: 920px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .cardHead{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .cardHead h2{
      margin:0;
      font-size: 14px;
      letter-spacing: 0.05em;
      font-weight: 900;
      color: #0b2a3c;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(14,165,164,.08);
      border: 1px solid rgba(14,165,164,.16);
      font-weight: 800;
      color: #0b2a3c;
      font-size: 12px;
      white-space:nowrap;
    }

    .cardBody{
      padding: 16px;
    }

    /* Status card (left) */
    .bigToken{
      font-size: 54px;
      font-weight: 900;
      letter-spacing: -0.04em;
      margin: 6px 0 10px;
      color: #0b2a3c;
    }

    .metaRow{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .mini{
      flex: 1 1 180px;
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      background: linear-gradient(180deg, #ffffff, #fbfeff);
    }
    .mini .k{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: .04em;
      margin:0 0 4px;
      text-transform: uppercase;
    }
    .mini .v{
      font-size: 18px;
      font-weight: 900;
      letter-spacing:-0.02em;
      margin:0;
      color:#0b2a3c;
    }

    .progress{
      margin-top: 12px;
      height: 10px;
      background: #eef6ff;
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid var(--line);
    }
    .bar{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--brand), var(--brand2));
      border-radius: 999px;
      transition: width .3s ease;
    }

    .hint{
      margin-top: 12px;
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
      line-height:1.4;
    }

    /* Form (right) */
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom: 12px;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 520px){
      .row2{ grid-template-columns: 1fr; }
    }

    label{
      font-size: 12px;
      color: #0b2a3c;
      font-weight: 900;
      letter-spacing: .04em;
      text-transform: uppercase;
    }

    input, textarea{
      font-family: inherit;
      font-size: 15px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      outline: none;
      background: #ffffff;
      color: var(--text);
      box-shadow: inset 0 1px 0 rgba(15,23,42,0.02);
    }
    textarea{ min-height: 46px; resize: vertical; }

    input:focus, textarea:focus{
      border-color: rgba(14,165,164,.55);
      box-shadow: 0 0 0 4px rgba(14,165,164,.12);
    }

    .help{
      margin-top: 2px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
      line-height:1.35;
    }

    .actions{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .btn{
      border: 0;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 900;
      font-size: 15px;
      cursor: pointer;
      min-width: 160px;
      transition: transform .05s ease, filter .15s ease;
    }
    .btn:active{ transform: translateY(1px); }

    .primary{
      color: white;
      background: linear-gradient(180deg, #14b8a6, #0ea5a4);
      box-shadow: 0 14px 26px rgba(14,165,164,.18);
    }
    .primary:hover{ filter: brightness(1.02); }

    .ghost{
      background: #ffffff;
      border: 1px solid var(--line);
      color: #0b2a3c;
    }

    .msg{
      margin-top: 12px;
      border-radius: 14px;
      padding: 12px 12px;
      border: 1px solid var(--line);
      background: #fbfeff;
      font-weight: 800;
      font-size: 13px;
      color: var(--muted);
      display:none;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .msg.ok{
      display:block;
      border-color: rgba(34,197,94,.25);
      background: rgba(34,197,94,.07);
      color: #0b2a3c;
    }
    .msg.err{
      display:block;
      border-color: rgba(176,0,32,.25);
      background: rgba(176,0,32,.06);
      color: #6b1020;
    }

    .yourToken{
      margin-top: 12px;
      border: 1px solid rgba(34,197,94,.25);
      background: rgba(34,197,94,.07);
      border-radius: var(--radius);
      padding: 14px 14px;
      display:none;
    }

    .yourToken .k{
      font-size: 12px;
      letter-spacing: .04em;
      text-transform: uppercase;
      font-weight: 900;
      color: #0b2a3c;
      margin:0 0 6px;
    }
    .yourToken .num{
      font-size: 44px;
      font-weight: 900;
      letter-spacing:-0.03em;
      margin:0 0 8px;
      color:#0b2a3c;
    }
    .yourToken .sub{
      margin:0;
      color: var(--muted);
      font-weight: 700;
      font-size: 13px;
    }
    .trackLink{
      display:inline-flex;
      margin-top: 10px;
      font-weight: 900;
      color: #0ea5a4;
      text-decoration: none;
    }
    .trackLink:hover{ text-decoration: underline; }

    .privacy{
      margin-top: 12px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
      line-height: 1.35;
    }

    /* Tiny footer */
    .footer{
      margin-top: 14px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Header -->
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">+</div>
        <div class="title">
          <h1>Clinic Token Booking</h1>
          <p>Reception-style booking â€¢ Live queue updates</p>
        </div>
      </div>

      <div class="chips">
        <div class="chip"><span style="opacity:.7">Clinic:</span> <span id="clinicChip">â€”</span></div>
        <div class="chip"><span class="liveDot"></span> Live</div>
      </div>
    </div>

    <!-- Quote banner -->
    <div class="quote" role="note" aria-label="Health tip">
      <div class="quoteIcon" aria-hidden="true">ðŸ’š</div>
      <div class="quoteText">
        <p class="big" id="quoteBig">Good health is a journey, not a destination.</p>
        <p class="small" id="quoteSmall">â€” Stay consistent</p>
      </div>
    </div>

    <!-- Main grid -->
    <div class="grid">
      <!-- Left: Queue status -->
      <div class="card">
        <div class="cardHead">
          <h2>QUEUE STATUS</h2>
          <div class="badge" id="refreshBadge">Auto-refresh</div>
        </div>

        <div class="cardBody">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <div>
              <div style="font-weight:900; letter-spacing:.05em; text-transform:uppercase; font-size:12px; color:var(--muted);">
                Now serving
              </div>
              <div class="bigToken" id="nowServing">â€”</div>
            </div>

            <div class="badge" id="peopleWaiting">People waiting: â€”</div>
          </div>

          <div class="metaRow">
            <div class="mini">
              <p class="k">Estimated wait</p>
              <p class="v"><span id="estWait">â€”</span> min</p>
            </div>
            <div class="mini">
              <p class="k">Comfort tip</p>
              <p class="v" id="comfortTip">Please stay hydrated</p>
            </div>
          </div>

          <div class="progress" aria-label="Queue progress">
            <div class="bar" id="progressBar"></div>
          </div>

          <div class="hint" id="hintText">
            This page updates automatically. Reserve your token and keep this tab open to track your turn.
          </div>
        </div>
      </div>

      <!-- Right: Reserve form -->
      <div class="card">
        <div class="cardHead">
          <h2>PATIENT REGISTRATION</h2>
          <div class="badge">Quick form</div>
        </div>

        <div class="cardBody">
          <div class="field">
            <label for="name">Patient name</label>
            <input id="name" type="text" placeholder="Enter full name" autocomplete="name"/>
          </div>

          <div class="row2">
            <div class="field">
              <label for="phone">Mobile number</label>
              <input id="phone" type="tel" placeholder="10 digits or +91XXXXXXXXXX" autocomplete="tel"/>
              <div class="help">Accepted: 10 digits or 91XXXXXXXXXX or +91XXXXXXXXXX</div>
            </div>

            <div class="field">
              <label for="address">Address (optional)</label>
              <input id="address" type="text" placeholder="Area / landmark" autocomplete="street-address"/>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="reserveBtn" onclick="reserveToken()">Reserve Token</button>
            <button class="btn ghost" onclick="clearForm()">Clear</button>
          </div>

          <div id="msg" class="msg"></div>

          <div id="yourTokenBox" class="yourToken">
            <p class="k">Your token</p>
            <p class="num" id="yourTokenNum">â€”</p>
            <p class="sub">Keep this page open. It updates automatically.</p>
            <a class="trackLink" id="trackLink" href="#" target="_blank" rel="noopener">Open tracking page</a>
          </div>

          <div class="privacy">
            <b>Privacy note:</b> Your details are used only for queue management by the clinic reception.
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      Powered by Q-Manage â€¢ Live updates enabled
    </div>
  </div>

  <script>
    const CLINIC_SLUG = "{{ clinic_slug|default:'' }}";

    // Quotes / tips (non-medical, motivational)
    const QUOTES = [
      { big: "Good health is a journey, not a destination.", small: "â€” Stay consistent" },
      { big: "Small steps today make a healthier tomorrow.", small: "â€” One step at a time" },
      { big: "Breathe in calm, breathe out stress.", small: "â€” Youâ€™re doing great" },
      { big: "Hydrate, relax, and let your body heal.", small: "â€” Take care" },
      { big: "Your well-being matters. Be kind to yourself.", small: "â€” Keep going" },
      { big: "Rest is productive when your body needs it.", small: "â€” Recover well" },
    ];

    const COMFORT_TIPS = [
      "Please stay hydrated",
      "Take slow, deep breaths",
      "Sit comfortably and relax",
      "Keep your phone handy for updates",
      "If you feel unwell, inform reception",
    ];

    function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

    function setQuote(){
      const q = pick(QUOTES);
      document.getElementById("quoteBig").textContent = q.big;
      document.getElementById("quoteSmall").textContent = q.small;
      document.getElementById("comfortTip").textContent = pick(COMFORT_TIPS);
    }

    function setMsg(text, ok=true){
      const el = document.getElementById("msg");
      el.className = "msg " + (ok ? "ok" : "err");
      el.textContent = text;
      el.style.display = "block";
    }

    function clearMsg(){
      const el = document.getElementById("msg");
      el.style.display = "none";
      el.textContent = "";
      el.className = "msg";
    }

    function clearForm(){
      document.getElementById("name").value = "";
      document.getElementById("phone").value = "";
      document.getElementById("address").value = "";
      clearMsg();
    }

    function normalizePhone(p){
      if(!p) return "";
      p = (""+p).trim().replace(/\s+/g,"");
      if(p.startsWith("+")) p = p.slice(1);
      return p.replace(/\D/g,"");
    }

    function disableReserve(disabled){
      const btn = document.getElementById("reserveBtn");
      btn.disabled = disabled;
      btn.style.opacity = disabled ? "0.7" : "1";
      btn.style.cursor = disabled ? "not-allowed" : "pointer";
    }

    async function getJson(url){
      const res = await fetch(url);
      const txt = await res.text();
      let j = null;
      try { j = JSON.parse(txt); } catch(e){ j = { ok:false, error: txt || ("HTTP "+res.status) }; }
      if(!res.ok) throw { status: res.status, ...j };
      return j;
    }

    async function postJson(url, data){
      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(data || {})
      });
      const txt = await res.text();
      let j = null;
      try { j = JSON.parse(txt); } catch(e){ j = { ok:false, error: txt || ("HTTP "+res.status) }; }
      if(!res.ok) throw { status: res.status, ...j };
      return j;
    }

    async function refreshSnapshot(){
      try{
        const j = await getJson(`/api/public/clinic/${encodeURIComponent(CLINIC_SLUG)}/snapshot/`);
        document.getElementById("nowServing").textContent = j.now_serving || "â€”";
        document.getElementById("peopleWaiting").textContent = `People waiting: ${j.people_waiting ?? "â€”"}`;
        document.getElementById("estWait").textContent = (j.estimated_wait_min ?? 0);

        // Progress bar: if estimated wait is 0 => full, else scaled (cap at 100)
        const wait = Number(j.estimated_wait_min ?? 0);
        let pct = 100;
        if (wait > 0){
          // assume 0..30 minutes typical for UI scaling
          pct = Math.max(5, Math.min(100, 100 - (wait/30)*100));
        }
        document.getElementById("progressBar").style.width = pct.toFixed(0) + "%";
      }catch(e){
        // keep UI stable; show minimal hint only
        document.getElementById("hintText").textContent = "Live updates are temporarily unavailable. Please refresh the page.";
      }
    }

    async function reserveToken(){
      clearMsg();
      disableReserve(true);

      const name = (document.getElementById("name").value || "").trim();
      const phoneRaw = document.getElementById("phone").value || "";
      const phone = normalizePhone(phoneRaw);
      const address = (document.getElementById("address").value || "").trim();

      if(!name){
        setMsg("Please enter patient name.", false);
        disableReserve(false);
        return;
      }
      if(!phone || !( (phone.length === 10) || (phone.startsWith("91") && phone.length === 12) )){
        setMsg("Please enter a valid mobile number (10 digits or 91XXXXXXXXXX or +91XXXXXXXXXX).", false);
        disableReserve(false);
        return;
      }

      try{
        const j = await postJson(`/api/public/clinic/${encodeURIComponent(CLINIC_SLUG)}/reserve/`, {
          name, phone: phoneRaw, address
        });

        setMsg(`Reserved successfully. Your token is ${j.token_number}.`, true);

        // Show token card + tracking link
        const box = document.getElementById("yourTokenBox");
        document.getElementById("yourTokenNum").textContent = j.token_number || "â€”";
        const trackUrl = (j.track_url || "");
        const link = document.getElementById("trackLink");
        link.href = trackUrl || "#";
        link.style.pointerEvents = trackUrl ? "auto" : "none";
        link.style.opacity = trackUrl ? "1" : "0.6";
        box.style.display = "block";

        // Update snapshot immediately
        await refreshSnapshot();

      }catch(e){
        const msg = e.error || e.detail || "Reservation failed";
        setMsg(msg + (e.status ? ` (HTTP ${e.status})` : ""), false);
      }finally{
        disableReserve(false);
      }
    }

    // init
    document.getElementById("clinicChip").textContent = CLINIC_SLUG || "â€”";
    setQuote();
    refreshSnapshot();
    setInterval(refreshSnapshot, 3000);
    setInterval(setQuote, 12000);
  </script>
</body>
</html>
