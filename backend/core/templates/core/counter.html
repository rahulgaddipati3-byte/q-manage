<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Counter Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: Arial, sans-serif; padding: 18px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    select, button { font-size: 16px; padding: 10px; }
    button { cursor: pointer; }
    .card { margin-top: 14px; padding: 14px; border: 1px solid #ddd; border-radius: 10px; }
    .big { font-size: 44px; font-weight: 700; margin: 10px 0; }
    .muted { color:#666; }
    .ok { color: green; }
    .err { color: #b00020; white-space: pre-wrap; word-break: break-word; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; font-size:14px; vertical-align: top; }
    th { background:#fafafa; }
    .pill { padding:2px 8px; border-radius:999px; background:#f2f2f2; display:inline-block; }
    .right { margin-left:auto; }
  </style>
</head>
<body>
  <h2>Counter Screen (Staff)</h2>

  <div class="row">
    <label><b>Counter:</b></label>
    <select id="counter">
      {% for c in counters %}
        <option value="{{ c.code }}">{{ c.code }} - {{ c.name }}</option>
      {% endfor %}
    </select>

    <button onclick="issueToken()">Issue Token</button>
    <button onclick="callNext()">Call Next</button>

    <a href="/ui/display/" target="_blank" style="margin-left:12px;">Open Customer Display</a>
    <a href="/admin-dashboard/" target="_blank" style="margin-left:12px;">Open Admin Dashboard</a>

    <span class="right muted" id="clock">—</span>
  </div>

  <div class="card">
    <div class="muted">Last action</div>
    <div id="msg" class="muted">—</div>
    <div class="big" id="big">—</div>
  </div>

  <div class="card">
    <div class="muted"><b>Queue (This Counter)</b></div>
    <div class="muted" id="qmsg">Loading…</div>

    <table>
      <thead>
        <tr>
          <th>Token</th>
          <th>Name</th>
          <th>Phone</th>
          <th>Address</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="qbody"></tbody>
    </table>
  </div>

<script>
async function postJson(url, data){
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });

  const txt = await res.text();
  let j = null;
  try { j = JSON.parse(txt); }
  catch(e) { j = { ok:false, error: txt || `HTTP ${res.status}` }; }

  if (!res.ok) throw { status: res.status, ...j };
  return j;
}

async function getJson(url){
  const res = await fetch(url, { cache: "no-store" });
  const txt = await res.text();
  let j = null;
  try { j = JSON.parse(txt); }
  catch(e) { j = { ok:false, error: txt || `HTTP ${res.status}` }; }
  if (!res.ok) throw { status: res.status, ...j };
  return j;
}

function getCounter(){
  return document.getElementById("counter").value;
}

function setMsg(text, ok=true){
  const el = document.getElementById("msg");
  el.className = ok ? "ok" : "err";
  el.textContent = text;
}

function esc(s){
  return (s || "").toString().replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function pick(obj, keys){
  for (const k of keys){
    const v = obj && obj[k];
    if (v !== undefined && v !== null && String(v).trim() !== "") return v;
  }
  return "";
}

async function issueToken(){
  const code = getCounter();
  try{
    const j = await postJson("/api/token/issue/", { counter: code });
    setMsg(`Issued token: ${j.number}`, true);
    document.getElementById("big").textContent = j.number;
    await loadQueue();
  }catch(e){
    setMsg((e.error || "Issue failed") + (e.status ? ` (HTTP ${e.status})` : ""), false);
  }
}

async function callNext(){
  const code = getCounter();
  try{
    const j = await postJson("/api/token/next/", { counter: code });
    setMsg(`Now serving at ${j.counter}: ${j.number}`, true);
    document.getElementById("big").textContent = j.number;
    await loadQueue();
  }catch(e){
    setMsg((e.error || "Call next failed") + (e.status ? ` (HTTP ${e.status})` : ""), false);
  }
}

async function loadQueue(){
  const code = getCounter();
  const msg = document.getElementById("qmsg");
  const body = document.getElementById("qbody");

  try{
    const j = await getJson(`/api/queue/status/?counter=${encodeURIComponent(code)}`);
    const rows = (j.waiting_list || []);

    msg.textContent =
      `Now serving: ${j.now_serving || "—"} | Waiting: ${j.waiting_count || 0} | Next: ${j.next_token || "—"}`;

    if (!rows.length){
      body.innerHTML = `<tr><td colspan="5" class="muted">No active tokens for this counter.</td></tr>`;
      return;
    }

    body.innerHTML = rows.map(r => {
      const nm = pick(r, ["customer_name","patient_name","name","full_name"]);
      const ph = pick(r, ["customer_phone","patient_phone","phone","mobile","phone_number","mobile_number"]);
      const ad = pick(r, ["customer_address","patient_address","address","location","addr"]);

      const st = pick(r, ["status"]) || "ACTIVE";

      return `
        <tr>
          <td><b>${esc(r.number)}</b></td>
          <td>${esc(nm)}</td>
          <td>${esc(ph)}</td>
          <td>${esc(ad)}</td>
          <td><span class="pill">${esc(st.toUpperCase())}</span></td>
        </tr>
      `;
    }).join("");

  }catch(e){
    msg.textContent = "Could not load queue. Check /api/queue/status/ endpoint.";
    body.innerHTML = `<tr><td colspan="5" class="err">Error loading queue</td></tr>`;
  }
}

function tickClock(){
  document.getElementById("clock").textContent = new Date().toLocaleString();
}

document.getElementById("counter").addEventListener("change", loadQueue);

tickClock();
setInterval(tickClock, 1000);

loadQueue();
setInterval(loadQueue, 3000);
</script>
</body>
</html>
