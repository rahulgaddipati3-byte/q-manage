

<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Counter Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: Arial, sans-serif; padding: 18px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    select, button { font-size: 16px; padding: 10px; }
    button { cursor: pointer; }
    .card { margin-top: 14px; padding: 14px; border: 1px solid #ddd; border-radius: 10px; }
    .big { font-size: 44px; font-weight: 700; margin: 10px 0; }
    .muted { color:#666; }
    .ok { color: green; }
    .err { color: #b00020; white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body>
  <h2>Counter Screen (Staff)</h2>

  <div class="row">
    <label><b>Counter:</b></label>
    <select id="counter">
      {% for c in counters %}
        <option value="{{ c.code }}">{{ c.code }} - {{ c.name }}</option>
      {% endfor %}
    </select>

    <button onclick="issueToken()">Issue Token</button>
    <button onclick="callNext()">Call Next</button>
    <a href="/ui/display/" target="_blank" style="margin-left:12px;">Open Customer Display</a>
    <a href="/admin-dashboard/" target="_blank" style="margin-left:12px;">Open Admin Dashboard</a>


    
  </div>

  <div class="card">
    <div class="muted">Last action</div>
    <div id="msg" class="muted">—</div>
    <div class="big" id="big">—</div>
  </div>

<script>
async function postJson(url, data){
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });

  const txt = await res.text();
  let j = null;
  try { j = JSON.parse(txt); }
  catch(e) { j = { ok:false, error: txt || `HTTP ${res.status}` }; }

  if (!res.ok) throw { status: res.status, ...j };
  return j;
}

function getCounter(){
  return document.getElementById("counter").value;
}

function setMsg(text, ok=true){
  const el = document.getElementById("msg");
  el.className = ok ? "ok" : "err";
  el.textContent = text;
}

async function issueToken(){
  const code = getCounter();
  try{
    // ✅ CORRECT: API endpoint
    const j = await postJson("/api/token/issue/", { counter: code });
    setMsg(`Issued token: ${j.number}`, true);
    document.getElementById("big").textContent = j.number;
  }catch(e){
    setMsg((e.error || "Issue failed") + (e.status ? ` (HTTP ${e.status})` : ""), false);
  }
}

async function callNext(){
  const code = getCounter();
  try{
    // ✅ CORRECT: API endpoint
    const j = await postJson("/api/token/next/", { counter: code });
    setMsg(`Now serving at ${j.counter}: ${j.number}`, true);
    document.getElementById("big").textContent = j.number;
  }catch(e){
    setMsg((e.error || "Call next failed") + (e.status ? ` (HTTP ${e.status})` : ""), false);
  }
}
</script>
</body>
</html>
